#!/bin/bash

#load configuration
SCRIPTPATH=$(cd ${0%/*} && pwd -P)
CONFIGFILE=$SCRIPTPATH/barkstopper.config

if [ ! -f $CONFIGFILE ]; then
  echo "Configuration file not found!"
  exit 1;
else 
  source $SCRIPTPATH/barkstopper.config
fi;

#sample the mic input
while true; do
  volume=$(rec -n stat trim 0 $SAMPLING_PERIOD 2>&1 | awk '/^Maximum amplitude/ { print $3 }')
  
  if [ $VERBOSE_MODE -eq 1 ]; then  
    echo $volume
  fi;
  
  if [ $BARK_LOUDNESS ]; then
    #play random mp3
    if awk "BEGIN {exit !($volume > $BARK_LOUDNESS)}"
    then
      mp3=$(find "$MP3_DIR" -name \*.mp3 -print | shuf -n 1)
      play "$mp3"
    fi;
  fi;
done
